function siteEvents(){console.log("siteEvents()");var e=$("div#sitediv");e.on("click","a.tablink",function(e){e.preventDefault();clickTabLink(this);return false})}function docKeypress(){}function loginSetup(){$("form.signin :input").bind("keydown",function(e){var t=e.keyCode?e.keyCode:e.which?e.which:e.charCode;if(t==13){document.getElementById("btnLogin").click();e.preventDefault()}})}function auth_check(){$.ajax({url:g_authurl,timeout:g_timeout,beforeSend:function(e){setAuthHeader(e)},success:function(e){loginok(e)},error:function(e,t,n){if(t==="timeout"){console.log("auth_check() timeout.  Retrying.");auth_check()}else{loginfailed()}}})}function auth_session_logout(e){console.log("session logout...");if(e==undefined){e=true}g_session=false;return $.ajax({url:g_authurl,async:e,beforeSend:function(e){setAuthHeader(e);e.setRequestHeader("Logout",g_username)},complete:function(e){console.log("session logout complete")}})}function auth_encode(e,t){var n=e+":"+t;var r=Base64.encode(n);return r}function deployTabs(){$(".tabcloser").click(function(e){e.preventDefault();TABS.byId[$(this).attr("href")].close()})}function addTab(e,t,n,r,i){console.log("addTab()");var s=new Tab(e,t,n,r,i);return s.id}function getTabByTitle(e){var t=$("li.tabhead.business"+g_business).find('a.tabtitle:contains("'+e+'")').attr("href");console.log("Found tab by title: "+t);return t}function activeTabId(){return $("li.tabhead.active.business"+g_business).find("a.tabcloser").attr("href")}function updateTab(e,t,n,r){console.log("updateTab()");if(isTabId(e)){var i=TABS.byId[e];i.setContent(t);i.setTitle(r);if(n){i.activate()}}else if(typeof e=="object"){e.empty().append(t)}else{console.log(typeof e+" passed to updateTab()");return false}return e}function getTabById(e){if(e==null){return activeTab()}if(isTabId(e)){return $("#tab"+e)}else{return e}}function activateTab(e){if(isTabId(e)){TABS.byId[e].activate()}}function closeTab(e){var t=$("div#tabs").find("div").size();if(!e){var e=activeTabId()}if($(".tablet"+e).hasClass("active")){console.log("tab ("+e+") was active");activateNextTab(e)}$(".tablet"+e).remove();if(t==1){$("div#tabs").fadeOut(300)}}function removeAllTabs(){console.log("removeAllTabs()");$("ul.tablist").children().remove();$("div.tablet").fadeOut(300);delete TABS;TABS=new Tabs}function setAuthHeader(e,t,n){if(t==undefined){t=g_username}if(n==undefined){n=g_password}if(!g_session){console.log("setting auth header");var r=auth_encode(t,n);e.setRequestHeader("Authorization","Silent "+r)}else{console.log("NOT setting auth header")}}function reauthenticate(){if(g_loggedin){console.log("refreshing session cookie");g_session=false;auth_check()}}function loginok(e){g_session=true;console.log("setting auth timer");window.setTimeout(reauthenticate,g_authtimeout);customLoginEvents(e)}function customLoginEvents(e){}function loginfailed(){g_password="";g_loggedin=false;alert("Login incorrect");setFocusLoginBox()}function logout(){console.log("logout()");dropMenu();select=$("select.businessselect");select.empty();select.append("<option>&lt;select business&gt;</option>");removeAllTabs();auth_session_logout();g_password="";g_loggedin=false;$("input:password[name=password]").val("");customLogoutActions();displayLoginBox()}function customLogoutActions(){}function displayLoginBox(){var e="#login-box";g_username=$("input:text[name=username]").val();$(e).fadeIn(300,function(){setFocusLoginBox()});var t=($(e).height()+24)/2;var n=($(e).width()+24)/2;$(e).css({"margin-top":-t,"margin-left":-n});$("#mask").fadeIn(300)}function setFocusLoginBox(){if(g_username==""){$("#username").focus()}else{$("#password").focus()}}function hideLoginBox(){$("#mask , .login-popup").fadeOut(300,function(){$("#mask").hide()})}function prepMenu(){$("nav.site ul").find("a").each(function(){$(this).click(clickMenu)})}function navicon(){$("div.navicon").click(function(){$("nav.site").toggle()})}function navitab(){$("div.navitab-box-front").text("0");$("div.navitab").click(function(){navitabIncrement()})}function navitabIncrement(){var e=parseInt($("div.navitab-box-front").text());$("div.navitab-box-front").text(++e)}function getMenu(){$.ajax({url:g_authurl+g_username+".xml",beforeSend:function(e){setAuthHeader(e)},success:function(e){setMenu(e)},error:function(e){setMenu(e)}})}function dropMenu(){$logout=$("a#logout").detach();$("div#menudiv").empty();$("div#menudiv").append($logout);$("a#logout").text("")}function setMenu(e){$logout=$("a#logout").detach();$(e).find("login").find("menu").each(function(){var e=$(this).attr("item");var t=$(this).attr("tooltip");var n=$(this).attr("href");var r=$('<a href="'+n+'" title="'+t+'">'+e+"</a>");$(r).on("click",{url:n},clickMenu);$("div#menudiv").append(r)});$("div#menudiv").append($logout);$("a#logout").text("Logout ("+g_username+")")}function clickMenu(e){e.preventDefault();ok=false;console.log("clickMenu()");if($(this).hasClass("disabled")){}else if($(this).attr("href")=="#"||$(this).hasClass("disabled")){console.log("Doing nothing, successfully");ok=true}else{statusHide();for(menu in g_menus){if($(this).attr("href")=="#"+g_menus[menu][0]){if(g_menus[menu][1]==alert){alert(g_menus[menu][2])}else{g_menus[menu][1].apply(this,Array.prototype.slice.call(g_menus[menu],2))}ok=true;break}}}if(!ok){addTab("Not Available","<h2>Feature Not Available Yet</h2>",true)}}function clickTabLink(e){var t=$(e).attr("href");console.log("clickTabLink("+t+")");showHTML(t,"Help",false);return e}function showQuery(e,t,n,r){$.ajax({url:collection_url(e),timeout:g_timeout,beforeSend:function(e){setAuthHeader(e)},success:function(i){displayResultsGeneric(i,e,t,n,r)},error:function(i){if(r){if(r.children().length>0){console.log("failed to load "+e+".  Retrying.");showQuery(e,t,n,r);return false}}displayResultsGeneric(i,e,t,n,r)}})}function showHTML(e,t,n,r){console.log("showHTML()");if(r)e=collection_url(e);showSpinner();return $.ajax({url:e,beforeSend:function(e){setAuthHeader(e)},success:function(e){hideSpinner();if(n){updateTab(n,e)}else{addTab(t,e,true)}},error:function(){if(n){updateTab(n,"Not found.")}else{addTab(t,"Not found.",false)}hideSpinner()}})}function getForm(e,t,n,r,i){console.log("getForm("+e+","+t+","+n+")");showSpinner();var s=fetchFormData(e,t);return $.when.apply(null,s).done(function(r){var s=Array.prototype.splice.call(arguments,1);var o=$.parseHTML(r[0]);cacheData(e,t,s);displayForm(e,t,n,o,s,i)}).fail(function(){console.log("fetchFormData() failed");hideSpinner()})}function cacheData(e,t,n){console.log("cacheData("+e+","+t+")");if(e=="account"&&t=="create"){g_xml_accounttype=n[0]}}function fetchFormData(e,t){console.log("fetchFormData("+e+","+t+")");var n=new Array;var r=false;var s="/html/forms/"+e+"/"+t+".html";n.push(getHTML(s));for(o in g_formdata){if(e==g_formdata[o][0]&&t==g_formdata[o][1]){for(i=0;i<=g_formdata[o][2].length-1;i++){n.push(getXML(collection_url(g_formdata[o][2][i])))}r=true}}if(!r){n.push($.Deferred().resolve())}return n}function activeTab(){return $("div.tablet.active.business"+g_business)}function populateForm(e,t,n){var r=new Array;var i="";var s="";var o=getTabById(e);if(n){$(n[0]).find("resources").find("row").children().each(function(){var e=this.tagName;var n=$(this).text();if(e=="id"||e==t){i=n}console.log(e+"="+n);var s=o.find("form."+t+" [name='"+e+"']");s.val(n);s.data("old",n);s.trigger("liszt:updated");if(["line_1","line_2","line_3","town","county","postcode","country"].indexOf(e)!=-1&&n.length>0){r.push(n)}});if(r.length>0){var s=r.join();console.log("locString:"+s);loadMap(s,e)}}else{console.log("No data to populate form.")}return i}function handleSubforms(e,t,n,r){console.log("handleSubforms()");$(t).find("form.subform").each(function(){var t=$(this).attr("action");var i=getTabById(e);var s=i.find("div."+t).find("table.datatable");var o=s.find("button.addrow:not(.btnAdd)");o.click(function(){if(t=="salesorderitems"){salesorderAddProduct(e,s)}else{addSubformEvent($(this),t,n,e)}});o.addClass("btnAdd");if(n){displaySubformData(t,n,r,e)}})}function tabTitle(e){return e}function isTabId(e){if(typeof e=="number"){return true}else if(typeof e=="string"){return!isNaN(e)}return false}function addOrUpdateTab(e,t,n,r){var i=undefined;if(typeof e=="undefined"){console.log("no container => new tab");i=new Tab(r,t,n)}else{console.log("container => update tab");var s=updateTab(e,t,n,r);if(typeof e==="object"){i=s}else{i=TABS.byId[s]}}return i}function displayForm(e,t,n,r,i,s){console.log('displayForm("'+e+'","'+t+'","'+n+'")');var n=tabTitle(n,e,t,i);var o=addOrUpdateTab(s,r,true,n);o.object=e;o.action=t;var u=o instanceof Tab?o.tablet:o;var a=t=="update"?1:0;u.find("select.populate:not(.sub)").each(function(){populateCombo(i[a++],$(this),o.id)});var f=t=="update"?populateForm(o.id,e,i):0;handleSubforms(o.id,r,f,i);finaliseForm(o.id,e,t,f)}function finaliseForm(e,t,n,r){console.log("finaliseForm()");formatDatePickers(e);formatRadioButtons(e,t);formBlurEvents(e);formEvents(e,t,n,r);activateTab(e);hideSpinner()}function formEvents(e,t,n,r){var i=getTabById(e);i.find("button.save").click(function(){doFormSubmit(t,n,r)});i.find("button.cancel").click(function(){TABS.active.close()});i.find("button.reset").click(function(e){e.preventDefault();i.find("form:not(.subform)").get(0).reset()});i.find("form:not(.subform):not(.nosubmit)").submit(function(e){e.preventDefault();doFormSubmit(t,n,r)});customFormEvents(e,t,n,r)}function customFormEvents(e,t,n,r){}function uploadFile(e,t){var n=new FormData(document.forms.namedItem("fileinfo"));showSpinner("Uploading File...");$.ajax({url:t,type:"POST",data:n,processData:false,contentType:false,beforeSend:function(e){setAuthHeader(e)},success:function(t){if(e){e(t)}else{hideSpinner()}},error:function(e){hideSpinner();alert("error uploading file")}})}function stripFirstRow(e){$(e).find("row:first").each(function(){$(this).remove()});return e}function fixXMLDates(e){$(e).find("transactdate").each(function(){var e=moment($(this).text());if(e.isValid()){$(this).replaceWith("<"+this.tagName+">"+e.format("YYYY-MM-DD")+"</"+this.tagName+">")}});return e}function fixXMLRequest(e){var t=createRequestXmlDoc(n);var n=$(e).find("resources").children().clone();$(t).find("data").each(function(){$(this).append(n)});return xml}function createRequestXmlDoc(){function t(){var t=e.createElement(arguments[0]),n,r;for(var i=1;i<arguments.length;i++){r=arguments[i];if(typeof r=="string"){r=e.createTextNode(r)}t.appendChild(r)}return t}var e=document.implementation.createDocument(null,null,null);xml=t("request",t("instance",g_instance),t("business",g_business),t("data"));return xml}function flattenXml(e){return(new XMLSerializer).serializeToString(e)}function formBlurEvents(e){customBlurEvents(e)}function customBlurEvents(e){}function formatRadioButtons(e,t){var n=getTabById(e);n.find("div.radio.untuned").find('input[type="radio"]').each(function(){var e=$(this).attr("id");$(this).attr("id","");$(this).uniqueId();$(this).parent().find('label[for="'+e+'"]').attr("for",$(this).attr("id"))});n.find("div.radio.untuned").buttonset();n.find("div.radio.untuned").change(function(){changeRadio($(this),t)});n.find("div.radio.untuned").removeClass("untuned")}function formatDatePickers(e){var t=getTabById(e);t.find(".datefield").datepicker({dateFormat:"yy-mm-dd",constrainInput:true})}function contactSearch(e){console.log('searching for contacts like "'+e+'"');searchQuery("contacts",e)}function searchQuery(e,t){console.log("Loading subform with data "+e);url=collection_url("search/"+e);if(t){url+=t+"/"}$.ajax({url:url,beforeSend:function(e){setAuthHeader(e)},success:function(n){displaySearchResults(e,t,n)},error:function(e){console.log("Error searching.")}})}function displaySearchResults(e,t,n){console.log("Search results are in.");var r=new Array;$(n).find("row").each(function(){var e=$(this).find("id").text();var t=$(this).find("name").text();r.push(t)});activeTab().find("input.contactsearch").autocomplete({source:r})}function changeRadio(e,t){var n=e.find('input[type="radio"]:checked').val();console.log("Radio tuned to "+n);if(t=="organisation"){if(n=="0"){$("tr.contact.link").hide();$("tr.contact.create").show()}else if(n=="1"){$("tr.contact.create").hide();$("tr.contact.link").show()}}}function doFormSubmit(e,t,n){console.log("doFormSubmit("+e+","+t+","+n+")");if(validateForm(e,t,n)){if(n>0){submitForm(e,t,n)}else{submitForm(e,t)}}}function validateForm(e,t,n){console.log("validating form "+e+"."+t);statusHide();return customFormValidation(e,t,n)}function customFormValidation(e,t,n){return true}function statusHide(){var e=activeTab().find("div.statusmsg");e.hide()}function statusMessage(e,t,n){var r=activeTab().find("div.statusmsg");if(r.length==0){console.log("No div.statusmsg - creating one");activeTab().find("div").first().prepend('<div class="statusmsg clearfix"/>');var r=activeTab().find("div.statusmsg")}r.stop(true,true);r.removeClass("info warn crit");if(t==STATUS_INFO){r.addClass("info")}else if(t==STATUS_WARN){r.addClass("warn")}else if(t==STATUS_CRIT){r.addClass("crit")}r.text(e);r.show();if(n){r.fadeOut(n)}}function formatThousands(e){var t=e.toString().split(".");t[0]=t[0].replace(/\B(?=(\d{3})+(?!\d))/g,",");return t.join(".")}function cloneInput(e,t,n){console.log("Cloning input "+t);if(t=="total"){var r="clone"}else{var r="nosubmit"}var i="input."+r+"."+t;var s=e.find(i);var o=s.parent().clone(true);o.addClass("xml-"+t);o.find(i).each(function(){$(this).val(n);$(this).removeClass(r);if(t=="qty"){$(this).addClass("endsub")}});return o}function populateCombos(e){console.log("populateCombos()");var t=new Array;var n=getTabById(e);n.find("select.populate:not(.sub)").each(function(){var e=$(this);$(this).parent().find("a.datasource").each(function(){datasource=$(this).attr("href");console.log("datasource: "+datasource);if(datasource=="relationships"&&g_xml_relationships){console.log("using cached relationship data");populateCombo(g_xml_relationships,e)}else{t.push(loadCombo(datasource,e))}})});console.log("combosity level is "+t.length);return $.when(t)}function loadCombo(e,t){console.log("loadCombo()");url=collection_url(e);console.log("populating a combo from datasource: "+url);return $.ajax({url:url,beforeSend:function(e){setAuthHeader(e)},success:function(n){if(e=="relationships"){console.log("caching relationship data");g_xml_relationships=n}populateCombo(n,t)},error:function(e){console.log("Error loading combo data")}})}function populateCombo(e,t,n){console.log("populateCombo()");console.log("Combo data loaded for "+t.attr("name"));if(!e){console.log("no data supplied for combo");return false}var r=[];var i=isTabId(n)?getTabById(n):n;for(var s=0;s<t[0].options.length;s++){r[t[0].options[s].text]=t[0].options[s].selected}t.empty();if(t.attr("data-placeholder")&&t.attr("multiple")!=true){console.log("combo has placeholder");var o=t.attr("data-placeholder");t.append($("<option />").val(-1).text(o))}$(e).find("row").each(function(){var e=$(this).find("id").text();var n=$(this).find("name").text();t.append($("<option />").val(e).text(n));if(r[e]){t[0].options[e].selected=r[e]}});if(t.hasClass("chosify")){t.chosen()}if(t.attr("name")=="type"){i.find("input.nominalcode").change(function(){return validateNominalCode($(this).val(),t.val())});t.change(function(){comboChange($(this),e,n)});$("div.chzn-container ul").attr("tabindex",-1)}else if(t.attr("name")=="account"){console.log("setting value of product->account combo");i.find('input.nosubmit[name="account"]').each(function(){t.find("option[value="+$(this).val()+"]").attr("selected","selected")})}else{t.change(function(){comboChange($(this),e,n)})}t.trigger("liszt:updated")}function comboChange(e,t,n){customComboChange(e,t,n)}function customComboChange(e,t,n){}function loadSubformData(e,t,n){console.log("loadSubformData()");console.log("Loading subform with data "+e);url=collection_url(e);if(t){url+=t+"/"}return $.ajax({url:url,beforeSend:function(e){setAuthHeader(e)},success:function(r){console.log("Loaded subform data");displaySubformData(e,t,[null,r],n)},error:function(r){console.log("Error loading subform data");displaySubformData(e,t,r,n)}})}function addSubformEvent(e,t,n,r){console.log("addSubformEvent()");console.log("Adding row to subform parent "+n);console.log("object:"+e);console.log("view:"+t);console.log("parentid:"+n);var i=t.split("_")[0];var s=t.split("_")[1];var o=collection_url(s);var u=createRequestXml();u+="<"+s.slice(0,-1)+">";var a=e.parent().parent();a.find("input").each(function(){var e=$(this).attr("name");if(e){if(e==s){u+="<"+e+' id="';u+=escapeHTML($(this).val());u+='"/>'}else{u+="<"+e+">";u+=escapeHTML($(this).val());u+="</"+e+">"}}});a.find("select").each(function(){console.log("deal with select(s)");var e=$(this).attr("name");if(e=="relationship"){u+='<relationship organisation="';u+=n+'" type="0" />'}if(e){console.log("I have <select> with name: "+e);$(this).find("option:selected").each(function(){u+="<"+e;u+=" "+i+'="'+n+'"';u+=' type="'+escapeHTML($(this).val());u+='"/>'})}});u+="</"+s.slice(0,-1)+">";u+="</data></request>";$.ajax({url:o,type:"POST",data:u,contentType:"text/xml",beforeSend:function(e){setAuthHeader(e)},success:function(e){console.log("SUCCESS: added row to subform");loadSubformData(t,n,r)},error:function(e){console.log("ERROR adding row to subform")}})}function newRow(e){if(e%2==0){return row=$('<tr class="even">')}else{return row=$('<tr class="odd">')}}function markComboSelections(e,t){if(t){var n=t.split(",");if(n.length>0){for(var r=0;r<n.length;r++){var i="option[value="+n[r]+"]";e.find(i).attr("selected",true)}}}}function clearForm(e){e.find("input[type=text]").each(function(){$(this).val("")});e.find("input[name=qty]").each(function(){$(this).val("1")});e.find("input[type=email]").each(function(){$(this).val("")});e.find("select.chzn-done:not(.sub)").val("");e.find("select.chzn-done:not(.sub)").trigger("liszt:updated")}function displaySubformData(e,t,n,r){console.log("displaySubformData()");var i=getTabById(r);var s=i.find("div."+e).find("table.datatable");var o=[];s.find("tbody").empty();if(n){if(e=="salesorderitems"){addSalesOrderProducts(r,s,n[1])}else{addSubFormRows(n[1],s,e,r)}}s.find("select.chosify").chosen();s.find("tbody").fadeIn(300);s.find("button.removerow").click(function(){btnClickRemoveRow(e,t,$(this).parent())});i.find("button.linkcontact").click(function(){btnClickLinkContact(t,r)});i.find("button.taxproduct").click(function(){var e=$(this).parent().parent().find("select.tax").val();taxProduct(t,e,true,r)})}function btnClickLinkContact(e,t){var n=getTabById(t);var r=n.find("select.contactlink").val();relationshipUpdate(e,r,false,true)}function btnClickRemoveRow(e,t,n){console.log("btnClickRemoveRow("+e+","+t+")");if(e=="salesorderitems"){console.log("skipping btnClickRemoveRow() for salesorder");return}var r=n.find('input[name="id"]').val();var i=collection_url(e)+t+"/"+r+"/";console.log("DELETE "+i);n.parent().hide();$.ajax({url:i,type:"DELETE",beforeSend:function(e){setAuthHeader(e)},complete:function(e){n.parent().remove()}})}function submitForm(e,t,n){var r=createRequestXml();var i="";var s="";var o=activeTab();var u=null;if(e=="salesorder"){var a="salesorderitem"}console.log("Submitting form "+e+":"+t);o.find("div."+e).find("form:not(.subform)").each(function(){s=$(this).attr("action");i=collection_url(s);if(n){i+=n}});console.log("submitting to url: "+i);r+="<"+e+">";o.find("div."+e).find("input:not(.nosubmit,default),select:not(.nosubmit,.default)").each(function(){var t=$(this).attr("name");if(t){var n=new Object;if(customFormFieldHandler($(this),n)){r+=n.xml}else{if(t=="subid"){u=$(this).val()}console.log("processing input "+t);if(t!="id"&&t!="subid"&&(t!="relationship"||e=="organisation_contacts")){if($(this).attr("type")=="checkbox"){r+="<"+t+">";r+=$(this).prop("checked")?"1":"0";r+="</"+t+">"}else{console.log($(this).val());if($(this).hasClass("sub")){r+="<"+a;if(u){r+=' id="'+u+'"';u=null}r+=">"}if($(this).val()!=$(this).data("old")){r+="<"+t+">";r+=escapeHTML($(this).val());r+="</"+t+">"}if($(this).hasClass("endsub")){r+="</"+a+">"}}}}}});if(e=="product"){r+='<tax id="1"/>'}r+="</"+e+">";r+="</data></request>";if(t=="create"||t=="update"){showSpinner("Saving "+e+"...")}else{showSpinner()}postXML(i,r,e,t,n,s)}function postXML(e,t,n,r,i,s){$.ajax({url:e,type:"POST",data:t,contentType:"text/xml",timeout:g_timeout,beforeSend:function(e){setAuthHeader(e)},success:function(e){hideSpinner();TABS.refresh(s);submitFormSuccess(n,r,i,s,e)},error:function(e,t,s){console.log(s);if(t=="timeout"){console.log("timeout");statusMessage("Timeout.  "+n+" not "+r+"d.",STATUS_CRIT);hideSpinner()}else{submitFormError(n,r,i)}}})}function customFormFieldHandler(e,t){return false}function escapeHTML(e){var t;var n={"&":"&","<":"&lt;",">":"&gt;",'"':"&quot;"};for(t in n){e=e.replace(new RegExp(t,"g"),n[t])}return e}function submitFormSuccess(e,t,n,r,i){if(!customSubmitFormSuccess(e,t,n,r,i)){return}newid=$(i).find(e).text();if(newid){console.log("data returned from POST");if(t=="create"){console.log("id of "+e+" created was "+newid);t="update";var s=new Array;var o="/html/forms/"+e+"/"+t+".html";s.push(getHTML(o));$.when.apply(null,s).done(function(n){displayForm(e,t,null,n,[i],activeTabId())}).fail(function(){console.log("failed to fetch html form");hideSpinner()})}}if(t=="create"){console.log("refreshing data entry form");getForm(e,t,TABS.active.title)}hideSpinner()}function submitFormError(e,t,n){hideSpinner();if(e=="salesorder"&&t=="process"){statusMessage("Billing run failed",STATUS_CRIT)}else{statusMessage("Error saving "+e,STATUS_CRIT)}}function collectionObject(e){if(e=="salesinvoices"){return"salesinvoice"}else if(e.substring(e.length-2)=="es"){return e.substring(0,e.length-2)}else{return e.substring(0,e.length-1)}}function displayElement(e,t,n){console.log("displayElement("+e+","+t+","+n+")");var r=collectionObject(e);if(!n){var n="Edit "+r.substring(0,1).toUpperCase()+r.substring(1)+" "+t}if(t){var i="update"}else{var i="create"}if(e.substring(0,8)=="reports/"){showHTML(collection_url(e)+t,n,false);return}showSpinner();var s=fetchElementData(e,t,r,i);$.when.apply(null,s).done(function(e){var t=Array.prototype.splice.call(arguments,1);displayForm(r,i,n,e[0],t)}).fail(function(){statusMessage("error loading data",STATUS_CRIT);hideSpinner()})}function fetchElementData(e,t,n,r){console.log("fetchElementData("+e+","+t+")");var i=collection_url(e)+t;var s="/html/forms/"+n+"/"+r+".html";var o=new Array;o.push(getHTML(s));if(t){o.push(getXML(i))}if(e=="accounts"){o.push(getXML(collection_url("accounttypes")))}else if(e=="organisations"){o.push(getXML(collection_url("organisation_contacts")+t+"/"));o.push(getXML(collection_url("relationships")));o.push(getXML(collection_url("contacts")))}else if(e=="products"){o.push(getXML(collection_url("product_taxes")+t+"/"));o.push(getXML(collection_url("accounts")));o.push(getXML(collection_url("taxes")))}else if(e=="salesorders"){o.push(getXML(collection_url("salesorderitems")+t+"/"));o.push(getXML(collection_url("cycles")));o.push(getXML(collection_url("products")))}return o}function getHTML(e){return $.ajax({url:e,type:"GET",dataType:"html",beforeSend:function(e){setAuthHeader(e)}})}function getXML(e,t){t=t===undefined?true:false;return $.ajax({url:e,type:"GET",async:t,dataType:"xml",timeout:g_timeout,beforeSend:function(e){setAuthHeader(e)},fail:function(){console.log("getXML("+e+") failed.  Retrying");getXML(e,t)}})}function divTable(e,t){e.empty();if($(t).find("resources").children().length==0){console.log("No results");return false}var n=$('<div class="formtable"/>');e.append(n);var r=0;$(t).find("resources").find("row").each(function(){r++;tr=$('<div class="tr"/>');n.append(tr);$(this).children().each(function(){var e="xml-"+this.tagName;var t=$(this).text()!=""?$(this).text():"&nbsp;";var n=$('<div class="td '+e+'">'+t+"</div>");tr.append(n)})})}function oddEven(e){return e%2==0?"even":"odd"}function toggleSelected(e){if(e.hasClass("selected")){e.removeClass("selected")}else{e.addClass("selected")}}function deselectAllRows(e){e.parent().find("div.tr").removeClass("selected")}function selectAllRows(e){e.parent().find("div.tr").addClass("selected")}function selectRowSingular(e){deselectAllRows(e);toggleSelected(e)}function accordionize(e){e.attr("height");e.find("div > h3").each(function(){$(this).click(accordionClick)})}function accordionClick(){if($(this).next().visible)return;$(this).parents("div.accordion").find("div.content").hide();$(this).parents("div.accordion").find("div.section > h3").removeClass("selected");$(this).addClass("selected");$(this).next().fadeIn(250)}function displayResultsGeneric(e,t,n,r,i,s){var o=false;statusHide();if(["accounts","contacts","departments","divisions","organisations","products"].indexOf(t)!=-1){o=true}if($(e).find("resources").children().length==0){hideSpinner();if(t=="contacts"){getForm("contact","create","Add New Contact")}else if(t=="organisations"){getForm("organisation","create","Add New Organisation")}else if(t=="products"){showForm("product","create","Add New Product")}else{$t='<div class="results empty">Nothing found</div>';if(i){updateTab(i,$t)}else{var i=new Tab(n,$t,true,t,o)}}return}$t='<a class="source" href="'+collection_url(t)+'"/>';$t+='<table class="datatable '+t+'">';$t+="<thead>";$t+="<tr>";var u=0;$(e).find("resources").find("row").each(function(){u++;if(u==1){$(this).children().each(function(){$t+='<th class="xml-';if(s){$t+=$(this).text().toLowerCase()+'">';$t+=$(this).text()}else{$t+=this.tagName+'">';$t+=this.tagName}$t+="  </th>"});$t+="</tr>";$t+="</thead>";$t+="<tbody>"}if(u%2==0){$t+='<tr class="even '+this.tagName+'">'}else{$t+='<tr class="odd '+this.tagName+'">'}$(this).children().each(function(){if(!(u==1&&s)){$t+='<td class="xml-'+this.tagName+'">';if(this.tagName=="price_buy"||this.tagName=="price_sell"){$t+=decimalPad($(this).text(),2)}else if(this.tagName=="nominalcode"){$t+=padString($(this).text(),4)}else{$t+=$(this).text()}if(this.tagName=="debit"||this.tagName=="credit"||this.tagName=="total"||this.tagName=="amount"||this.tagName=="tax"||this.tagName=="subtotal"){if($(this).text().substr(-1)!=")"){$t+=" "}}$t+="</td>"}});if(t=="salesinvoices"){var e=$(this).find("ref").text();var n="SI-"+e.replace("/","-")+".pdf";var r="SI/"+e;$t+='<td class="xml-pdf">';$t+='<a id="'+r+'" href="/pdf/'+g_orgcode+"/";$t+=n+'">[PDF]</a>';$t+="</td>"}$t+="</tr>"});$t+="</tbody>";$t+="</table>";if(!n){n="Results"}$t=$($t);$t.find("tr").click(clickElement);if(i){updateTab(i,$t)}else{addTab(n,$t,true,t,o)}if(r){getTabById(i).find(".datatable").tablesorter({sortList:[[0,0],[1,0]],widgets:["zebra"]})}hideSpinner()}function clickElement(){var e=$(this);var t=TABS.active;if(!customClickElement(e)){var n=e.find("td.xml-id").text();displayElement(t.collection,n)}}function customClickElement(e){return false}function showSpinner(e){if(e){$(".spinwaittxt").text(e)}else{$(".spinwaittxt").text("Please wait...")}$("#loading-div-background").show()}function hideSpinner(){$("#loading-div-background").hide()}function collection_url(e){var t;t="/"+g_instance+"/"+g_business+"/"+e;if(e.substr(e.length-1,1)!=="/")t+="/";return t}function decimalAdd(e,t){e=new Big(e);t=new Big(t);return e.plus(t)}function decimalSubtract(e,t){e=new Big(e);t=new Big(t);return e.minus(t)}function decimalEqual(e,t){return Number(e)==Number(t)}function decimalPad(e,t){if(isNaN(e)||e==""){e="0"}e=String(Number(e));var n=String(e).match(/\./g);if(n){pindex=String(e).indexOf(".");places=String(e).length-pindex-1;if(places<t){e=String(e)+Array(t).join("0")}}else if(t==0){e=String(e)}else if(t>0){e=String(e)+"."+Array(t+1).join("0")}return e}function padString(e,t){e=""+e;return e.length<t?padString("0"+e,t):e}function roundHalfEven(e,t){var n=Big(e);return n.round(t,2)}function createRequestXml(){var e='<?xml version="1.0" encoding="UTF-8"?><request>';e+="<instance>"+g_instance+"</instance>";e+="<business>"+g_business+"</business>";e+="<data>";return e}function prepBusinessSelector(){console.log("prepBusinessSelector()");$.ajax({url:collection_url("businesses"),beforeSend:function(e){setAuthHeader(e)},success:function(e){showBusinessSelector(e)},error:function(e){customBusinessNotFound(e)}})}function customBusinessNotFound(e){}function showBusinessSelector(e){if($(e).find("row").length==0){customBusinessNotFound(e);return}select=$("select.businessselect");select.empty();g_xml_business=e;$(e).find("row").each(function(){var e=$(this).find("id").text();var t=$(this).find("name").text();select.append($("<option />").val(e).text(t))});select.change(function(){switchBusiness($(this).val())});$("select.businessselect").val(g_business);switchBusiness(g_business)}function switchBusiness(e){$("div.tablet").addClass("hidden");$("li.tabhead").each(function(){$(this).addClass("hidden")});g_business=e;$(g_xml_business).find("row").each(function(){if($(this).find("id").text()==e){g_orgcode=$(this).find("orgcode").text()}});$("li.tabhead.business"+g_business).each(function(){$(this).removeClass("hidden")});$("div.tablet.business"+g_business).each(function(){$(this).removeClass("hidden")})}function mapUpdate(){console.log("mapUpdate()");var e=activeTab();var t=["line_1","line_2","line_3","town","county","country","postcode"];var n=new Array;var r=t.join('"],input[name="');r='input[name="'+r+'"]';mytab.find(r).each(function(){if($(this).val().length>0){n.push($(this).val())}});if(n.length>0){var i=n.join();console.log("locString:"+i);loadMap(i,mytab)}}function loadMap(e,t){var n;var r;var i={zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP};if(t){mytab=getTabById(t)}else{mytab=activeTab()}mytab.find(".map-canvas").each(function(){console.log("found a map-canvas");n=this;$(n).empty();r=new google.maps.Map(n,i);$(n).fadeIn(300,function(){renderMap(r,e)})})}function renderMap(e,t){var n=new google.maps.Geocoder;n.geocode({address:t},function(t,n){if(n==google.maps.GeocoderStatus.OK){e.setCenter(t[0].geometry.location);var r=new google.maps.Marker({map:e,position:t[0].geometry.location})}else{console.log("Geocode was not successful for the following reason: "+n)}});google.maps.event.trigger(e,"resize")}function newtab(){var e=new Object;e.id=++g_tabid;e.classes="tabhead tablet"+e.id+" business"+g_business;e.contentClasses="tablet tablet"+e.id+" business"+g_business;return e}function randomString(e){var t=new Array;var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var r=0;r<e;r++){t.push(n.charAt(Math.floor(Math.random()*n.length)))}return t.join("")}function isDate(e){var t=new Date(e);return!isNaN(t)&&e.length==10}function form_url(e){return g_url_form+e.object+"/"+e.action+".html"}function showForm(e,t,n,r){console.log("showForm("+e+"."+t+")");showSpinner();var i=new Form(e,t,n,r);i.load().done(function(){i.activate();hideSpinner()}).fail(function(){hideSpinner()});return i.tab}function Form(e,t,n,r){if(!(this instanceof Form))return new Form(e,t,n);console.log("Form() constructor");this.collection=e+"s";this.object=e;this.action=t;this.id=r;this.title=n;this.data={};this.sources=this.dataSources()}function Map(){if(!(this instanceof Map))return new Map;this.geodata=new Array;this.fields=new Array}function Tab(e,t,n,r,i){if(!(this instanceof Tab))return new Tab(e,t,n,r,i);console.log("Tab() constructor");e=e.substring(0,g_max_tabtitle);console.log("title: "+e);var s=TABS.byTitle[e];if(s!==undefined){if(s.business===g_business){console.log('Tab with title "'+e+'" exists.  Updating.');if(t){s.setContent(t)}if(n){s.activate()}return s}}this.title=e;TABS.add(this);this.business=g_business;this.collection=r;this.frozen=false;this.refresh=i;this.active=false;this.object=null;this.action=null;console.log("creating new Tab(id="+this.id+")");this.classes=new Array;this.classes.push("business"+this.business);this.classes.push("tablet"+this.id);if(this.collection){this.classes.push(r)}if(this.refresh){this.classes.push("refresh")}var o=this.classes.join(" ");this.tabli=$("<li/>",{id:"tabli"+this.id,"class":"tabhead"});this.tabli.addClass(o);this.tabhead=$("<div/>",{id:"tabhead"+this.id,"class":"tabhead clearfix"});this.tabtitle=$("<div/>",{"class":"tabtitle"});this.tabtitlelink=$("<a/>",{"class":"tabtitle",href:this.id});this.tabtitlelink.append(this.title);this.tabtitle.append(this.tabtitlelink);this.tabx=$("<div/>",{"class":"tabx"});this.tabcloser=$("<a/>",{id:"tabcloser"+this.id,"class":"tabcloser",href:this.id}).append("X");this.tabx.append(this.tabcloser);this.tabhead.append(this.tabtitle);this.tabli.append(this.tabhead);this.tabhead.append(this.tabx);$("ul.tablist").append(this.tabli);var u=this.id;this.tabli.click(function(e){e.preventDefault();activateTab(u)});var s=this;this.tabx.click(function(e){e.preventDefault();s.close()});this.tablet=$("<div/>",{id:"tab"+this.id});this.tablet.addClass(o);this.tablet.addClass("tablet");$("div.tabcontent").append(this.tablet);this.setContent(t);if(n){this.activate()}}function Tabs(){console.log("Tabs() constructor");this.byId=new Array;this.byTitle={}}function stripXmlFields(e,t){console.log("stripXmlFields()");for(var n=0;n<t.length;n++){e.find(t[n]).remove()}return e}var g_gladd_version="1.0.2";var g_authurl="/auth/";var g_url_form="/html/forms/";var g_authtimeout=6e4;var g_username="";var g_password="";var g_instance="";var g_business="1";var g_loggedin=false;var g_tabid=0;var g_max_tabtitle="48";var g_session=false;var TABS=new Tabs;var g_timeout=1e4;var STATUS_INFO=1;var STATUS_WARN=2;var STATUS_CRIT=4;$(document).ready(function(){if(g_password==""){displayLoginBox()}deployTabs();prepMenu();navicon();navitab();$("img#logo").click(function(e){e.preventDefault();dashboardShow()});loginSetup();$("button.submit").click(function(){g_username=$("input:text[name=username]").val();g_password=$("input:password[name=password]").val();auth_check()});$(window).unload(function(){logout()});$(document).keypress(docKeypress);siteEvents()});$.fn.populate=function(e){$(this).each(function(){$(this)._populate(e)})};$.fn._populate=function(e){console.log("$.populate(): "+$(this).attr("name"));var t=$(this);var n=[];if(e===undefined){console.log("No data for combo.  Skipping.");return false}for(var r=0;r<t[0].options.length;r++){n[t[0].options[r].text]=t[0].options[r].selected}t.empty();if(t.attr("data-placeholder")&&t.attr("multiple")!=true){console.log("combo has placeholder");var i=t.attr("data-placeholder");t.append($("<option />").val(-1).text(i))}$(e).find("row").each(function(){var e=$(this).find("id").text();if(!isNaN(e)){e=String(parseInt(e,10))}var r=$(this).find("name").text();t.append($("<option />").val(e).text(r));if(n[e]!==undefined){t[0].options[e].selected=n[e]}})};$.fn.accordionTab=function(e){return $(this).find("div.accordion div.section:nth-child("+e+") div")};$.fn.accordionTitle=function(e){return $(this).find("div.accordion div.section:nth-child("+e+") h3")};$.fn.accordionTabSelect=function(e){$(this).accordionTitle(e).each(accordionClick)};var __nativeST__=window.setTimeout,__nativeSI__=window.setInterval;window.setTimeout=function(e,t){var n=this,r=Array.prototype.slice.call(arguments,2);return __nativeST__(e instanceof Function?function(){e.apply(n,r)}:e,t)};window.setInterval=function(e,t){var n=this,r=Array.prototype.slice.call(arguments,2);return __nativeSI__(e instanceof Function?function(){e.apply(n,r)}:e,t)};jQuery.expr[":"].notparents=function(e,t,n){return jQuery(e).parents(n[3]).length===0};if(typeof String.prototype.trim==="undefined"){String.prototype.trim=function(){return String(this).replace(/^\s+|\s+$/g,"")}}if(typeof String.prototype.formatCurrency==="undefined"){String.prototype.formatCurrency=function(){var e=String(this);e=roundHalfEven(this,2);e=decimalPad(e,2);return formatThousands(e)}}Form.prototype.activate=function(){if(this.tab==undefined)this.show();console.log("Form().activate()");this.tab.activate();return this};Form.prototype.customXML=function(){};Form.prototype.dataSources=function(){var e;if(FORMDATA!==undefined){if(FORMDATA[this.object]!==undefined){if(FORMDATA[this.object][this.action]!==undefined){e=FORMDATA[this.object][this.action].slice()}}}return e};Form.prototype.events=function(){console.log("Form().events()");var e=this;var t=this.tab.tablet;t.find("a.tablink").off().click(function(){clickTabLink()});t.find("button.add").off().click(function(){var t=$(this).closest("div.form");e.rowAdd(t);return false});t.find("button.cancel").off().click(function(){e.tab.close();return false});t.find("button.del").off().click(function(){e.rowDelete($(this));return false});t.find("button.reset").off().click(function(t){t.preventDefault();e.reset();return false});t.find("button.save").off().click(function(){if(e.validate())e.submit();return false});t.find(".onchange").off().change(function(){e.onChange($(this));return false});customFormEvents(this.tab,this.object,this.action,this.id)};Form.prototype.fetchData=function(){console.log("Form().fetchData()");var e=new Array;e.push(getHTML(form_url(this)));if(this.action!=="create"&&this["FORMDATA"]===undefined&&this.id!==undefined){e.push(getXML(collection_url(this.collection)+this.id))}var t=0;if(this.sources!==undefined){for(var n=0,t=this.sources.length;n<t;n++){var r=this.sources[n].replace("{id}",this.id);if(this.sources[n]!==r)this.sources[n]=r;var i=collection_url(r);e.push(getXML(i))}}console.log("loading 1 html + "+t+" xml documents");return e};Form.prototype.finalize=function(){console.log("Form().finalize()");this.formatDatePickers();this.formatRadioButtons();this.formatSelects();this.events();this.updateMap();this.updateAllTotals()};Form.prototype.formatDatePickers=function(){console.log("Form().formatDatePickers()");formatDatePickers(this.tab.id)};Form.prototype.formatRadioButtons=function(){console.log("Form().formatRadioButtons()");formatRadioButtons(this.tab.id,this.object)};Form.prototype.formatSelects=function(){this.workspace.find("select.chozify").chosen()};Form.prototype.formFill=function(e){console.log("Form().formFill()");var t=e.closest("div.tr");if(e.is("select")){if(e.val()===e.find("option:first").val()){t.find("input").each(function(){if($(this).data("placeholder.orig")!==undefined){$(this).attr("placeholder",$(this).data("placeholder.orig"));$(this).trigger("change")}});return this}}var n=$(this.data[e.data("source")]);var r=n.find("resources row").filter(function(){return $(this).find("id").text()===e.val()});r.children().each(function(){var e=t.find('[name="'+this.tagName+'"]');if(e!==undefined){if(e.data("placeholder.orig")===undefined){e.data("placeholder.orig",e.attr("placeholder"))}var n=$(this).text();if(e.hasClass("currency"))n=decimalPad(n,2);e.attr("placeholder",n);if(e.val()==="")e.trigger("change")}})};Form.prototype.hasMap=function(){return this.map!==undefined};Form.prototype.load=function(){console.log("Form().load()");var e=this;var t=this.object;var n=this.action;var r=this.fetchData();return $.when.apply(null,r).done(function(r){console.log("Form() data loaded");e.html=Array.isArray(r)?r[0]:r;var i=Array.prototype.splice.call(arguments,1);if(n=="create"){e.data["FORMDATA"]=null}else if(e.data["FORMDATA"]===undefined){e.data["FORMDATA"]=$(i.shift()[0])}else{i.shift()}e.updateDataSources(i);console.log("Form("+t+"."+n+").load() done")}).fail(function(){console.log("Form("+t+"."+n+").load() fail")});return this};Form.prototype.onChange=function(e){console.log("Form().onChange()");if(e.hasClass("formfill"))this.formFill(e);if(e.hasClass("addend"))this.rowSum(e);if(e.hasClass("multiplicand"))this.rowMultiply(e);if(e.hasClass("currency")&&e.val()!==""&&!isNaN(e.val())){e.val(decimalPad(roundHalfEven(e.val(),2),2))}if(e.hasClass("sum"))this.updateFormTotals(e)};Form.prototype.populate=function(){console.log("Form().populate()");var e=this.data==={}||this.data===undefined;if(e)console.log("No data to populate form.");var t=undefined;var n=this;this.workspace=$(this.html);if(this.workspace.filter("div.map-canvas").length!==0){this.map=new Map}var r=this.workspace.find("form:not(.subform)").first().attr("action");if(r!==undefined)this.collection=r;var i=this.workspace.filter("div."+this.object+"."+this.action).first();i.find("select.populate:not(.sub)").each(function(){var e=n.data[$(this).attr("data-source")];$(this).populate(e)});if(!e){if(this.data["FORMDATA"]){this.data["FORMDATA"].find("resources row").first().children().each(function(){var e=this.tagName;var t=$(this).text();console.log(e+"="+t);if(e=="id"||e==this.object){n.id=t}var r=i.find("form."+n.object+' [name="'+e+'"]');if(r.length>0){r.val(t);r.data("old",t);if(n.hasMap()){if(MAPFIELDS[n.object].indexOf(e)!=-1&&t.length>0){n.map.addGeo(t)}}}else{console.log('field "'+e+'" not found on form')}})}}this._populateSubforms();this.url=collection_url(this.collection);if(this.id!==undefined)this.url+=this.id;console.log("Form().url="+this.url)};Form.prototype._populateSubforms=function(){console.log("Form()._populateSubforms()");var e=this;var t=this.workspace.find("form.subform");var n,r,i;if(t.length===0){t=this.workspace.find("form div.form");t.each(function(){var r=$(this).data("source");if(r===undefined){r=$(this).data("tag")+"s"}r+="/"+e.id+"/";var i=$(e.data[r]);var s=i.find("row");var o=t.find("div.subformwrapper div.tr");for(n=o.length;n<s.length;n++){e.rowAdd(t)}o=t.find("div.subformwrapper div.tr");$.each(s,function(t,n){var r=$(n).find("id");if(r.length===1)o.eq(t).data("id",r.text());$(n).children().each(function(n,r){var i=r.tagName;var s=$(r).text();var u=o.eq(t).find('[name="'+i+'"]');u.val(s);if(u.hasClass("formfill"))e.formFill(u)})})})}else{t.each(function(){var t=$(this).attr("action");loadSubformData(t,e.id,e.tab.id)})}};Form.prototype.post=function(){var e=this;return $.ajax({url:this.url,type:"POST",data:this.xml,contentType:"text/xml",timeout:g_timeout,beforeSend:function(e){setAuthHeader(e)},success:function(t){e.submitSuccess(t)},error:function(t,n,r){e.submitError(t,n,r)}})};Form.prototype.reset=function(){console.log("Form().reset()");var e=this.tab.tablet;var t=e.find("form");t.get(0).reset();t.find("input,select").each(function(){if($(this).val()!==$(this).data("old")&&$(this).data("old")!==undefined){$(this).val($(this).data("old"))}if($(this).data("placeholder.orig")!==undefined){$(this).attr("placeholder",$(this).data("placeholder.orig"));$(this).trigger("change")}});t.find("div.form div.tr.sub:not(:first)").remove();this._populateSubforms();this.updateAllTotals();statusHide()};Form.prototype.rowAdd=function(e){console.log("Form().rowAdd()");var t=e.data("object");var n=e.find("div.subformwrapper div.tr:first").clone(true,true);n.removeData();n.find("input").each(function(){var e=$(this).data("default");if(e!==undefined){$(this).val(e)}else{$(this).val("")}if($(this).data("placeholder.orig")!==undefined){$(this).attr("placeholder",$(this).data("placeholder.orig"))}});n.find("select").each(function(){$(this).val($(this).find("option:first").val())});var r=e.find("div.subformwrapper");if(r.length!==0){r.append(n)}else{e.append(n)}};Form.prototype.rowDelete=function(e){console.log("Form().rowDelete()");var t=e.closest("div.tr");var n=t.data("id");if(n===undefined){t.remove()}else{t.hide();var r=t.find("div.td");r.children(":not(.stet)").remove();r.append('<input type="hidden"/>');t.data("deleted","true")}this.updateAllTotals()};Form.prototype.rowMultiply=function(e){console.log("Form().rowMultiply()");var t=e.closest("div.tr");t.find(".sum").each(function(){$(this).val("1.00");var e=$(this);t.find(".multiplicand").each(function(){var t=Big(e.val());var n=Big(0);if($(this).val()===""){if($(this).attr("placeholder")!==undefined&&!isNaN($(this).attr("placeholder"))){n=Big($(this).attr("placeholder"))}}else if(!isNaN($(this).val())){n=Big($(this).val())}var r=t.times(n);if(e.hasClass("currency")){r=decimalPad(roundHalfEven(r,2),2)}e.val(r);e.trigger("change")})})};Form.prototype.rowSum=function(e){console.log("Form().rowSum()");var t=e.closest("div.tr");t.find(".sum").each(function(){$(this).val("0.00");var e=$(this);t.find(".addend").each(function(){if($(this).val()===""){if($(this).attr("placeholder")!==undefined&&!isNaN($(this).attr("placeholder"))){e.val(decimalAdd(e.val(),$(this).attr("placeholder")))}}else if(!isNaN($(this).val())){e.val(decimalAdd(e.val(),$(this).val()))}e.trigger("change")})})};Form.prototype.show=function(e){console.log("Form().show()");if(e===undefined&&this.tab===undefined){e=new Tab(this.title);this.tab=e;e.form=this}if(this.title!==undefined){console.log("setting tab title");this.tab.setTitle(this.title)}if(this.html!==undefined){console.log("setting tab content");this.populate();this.tab.setContent(this.workspace);this.finalize()}else{console.log("no tab content")}return this};Form.prototype.submit=function(){console.log("Form().submit() => "+this.url);var e=createRequestXml();e+="<"+this.object+">";var t;var n=this.tab.tablet.find("div."+this.object+"."+this.action+" form");var r=n.find("div.td").children();if(r.length===0)r=n.find("input,select");r.each(function(){var n=$(this).attr("name");if($(this).attr("type")!=="checkbox"){if(n)console.log(n+"="+$(this).val());var r=$(this).closest("div.form");if(r.length===1){if($(this).closest("div.td").is(":first-child")&&$(this).is(":first-child")){if(r.data("tag")!==undefined){t=r.data("tag")}else{t=r.data("object")}var i="";var s=$(this).closest("div.tr").data("id");var o=$(this).closest("div.tr").data("deleted");if(s!==undefined)i+=' id="'+s+'"';if(o!==undefined)i+=' is_deleted="true"';e+="<"+t+i+">"}}if(n){if(!$(this).hasClass("nosubmit")&&$(this).val()!==$(this).data("old")&&!($(this).data("old")===undefined&&$(this).val()==="")){console.log(n+' has changed from "'+$(this).data("old")+'" to "'+$(this).val()+'"');var u=$(this).val();if(Array.isArray(u)===false){u=[u]}for(var a=0;a<u.length;a++){var f=new Object;if(customFormFieldHandler($(this),f)===true){e+=f.xml}else{e+="<"+n+">";e+=escapeHTML(u[a]);e+="</"+n+">"}}}}if(r.length===1){if($(this).closest("div.td").is(":last-child")&&$(this).is(":last-child")){e+="</"+t+">"}}}});this.xml=e;this.customXML();this.xml+="</"+this.object+">";this.xml+="</data></request>";console.log(this.xml);if(this.action==="create"||this.action==="update"){showSpinner("Saving "+this.object+"...")}else{showSpinner()}this.post()};Form.prototype.submitError=function(e,t,n){console.log(n);hideSpinner();if(t==="timeout"){console.log("timeout");statusMessage("Timeout. "+this.object+" not "+this.action+"d.",STATUS_CRIT)}else if(!this.submitErrorCustom(e,t,n)){statusMessage("Error saving "+object,STATUS_CRIT)}};Form.prototype.submitErrorCustom=function(e,t,n){return false};Form.prototype.submitSuccessCustom=function(e,t,n){return false};Form.prototype.submitSuccess=function(e){console.log("form submitted successfully");hideSpinner();TABS.refresh(this.collection);this.submitSuccessCustom(e);this.id=$(e).find("id").text();if(!this.id)console.log("id not found");if(this.id){this.data["FORMDATA"]=$(e);if(this.action==="create"){console.log("POST returned new "+this.object+" with id="+this.id);this.action="update";this.sources=this.dataSources();this.url+=this.id;this.html=undefined}this.title=tabTitle("Edit "+this.object+" "+this.id,this.object,this.action,[e]);this.tab.setTitle(this.title);var t=this;this.load().done(function(){t.show()})}};Form.prototype.updateDataSources=function(e){if(this.sources===undefined)return;console.log("Form().updateDataSources()");var t=this.sources;console.log("data["+e.length+"]; sources["+t.length+"]");for(var n=0;n<t.length&&e[n]!==undefined;n++){console.log("Form().updateDataSources() - saving "+t[n]);this.data[t[n]]=e[n][0]}console.log("Form().updateDataSources() done")};Form.prototype.updateAllTotals=function(){console.log("Form().updateAllTotals()");var e=this;var t=this.tab.tablet;t.find("input.onchange.multiplicand").each(function(){e.rowMultiply($(this))});t.find("input.onchange.addend").each(function(){e.rowSum(this)})};Form.prototype.updateFormTotals=function(e){console.log("Form().updateFormTotals()");var t=this.tab.tablet;var n="0.00";t.find(".sum").each(function(){n=decimalAdd(n,$(this).val())});var r=t.find(".subtotal");if(r.hasClass("currency")){n=String(n).formatCurrency()}r.val(n)};Form.prototype.updateMap=function(){console.log("Form().updateMap()");if(this.hasMap()){this.map.tab=this.tab;this.map.load()}};Form.prototype.validate=function(){console.log("Form().validate()");statusHide();var e=this.tab.tablet;var t=true;e.find('[required="required"]').each(function(){if($(this).is("select")&&$(this).val()<0||$(this).is("input")&&$(this).val()===""){console.log($(this).attr("name"));if(t){if($(this).data("required-message")!==undefined){statusMessage($(this).data("required-message"),STATUS_WARN)}else{statusMessage($(this).attr("name")+" is required",STATUS_WARN)}$(this).focus()}t=false}});if(t)t=this.validateCustom();return t};Form.prototype.validateCustom=function(){return true};Map.prototype.addGeo=function(e){console.log("Map().addGeo("+e+")");this.geodata.push(e)};Map.prototype.clearGeo=function(){this.geodata.length=0};Map.prototype.load=function(){console.log("Map().load()");if(this.tab===undefined)return;if(this.geodata.length>0){this.geostring=this.geodata.join();loadMap(this.geostring,this.tab.id)}};Tab.prototype.activate=function(){console.log("Tab().activate()");if(this.active===true){this.reload();return false}console.log("activating Tab "+this.id);$(".business"+g_business).removeClass("active");$(".tablet"+this.id).addClass("active");var e=this.tablet;e.find(".focus").focus();$(".tablet"+this.id).find(".focus").fadeIn(300);for(var t=0;t<TABS.byId.length;t++){if(TABS.byId[t]!=undefined){if(TABS.byId[t].business==g_business){TABS.byId[t].active=false}}}this.active=true;TABS.active=this;return this};Tab.prototype.close=function(){console.log("Tab("+this.id+").close()");if(this.active){console.log("closing active tab");TABS.activateNext()}$(".tablet"+this.id).remove();if(TABS.count()==1)$("div#tabs").fadeOut(300);TABS.close(this);return this};Tab.prototype.events=function(){console.log("Tab().events()");var e=this;var t=this.tablet};Tab.prototype.find=function(e){return this.tablet.find(e)};Tab.prototype.reload=function(){if(this.collection&&!this.frozen&&this.business==g_business){console.log("refreshing tab "+this.id);showQuery(this.collection,this.title,this.sort,this.tablet)}return this};Tab.prototype.setContent=function(e){console.log("tab("+this.id+").setContent()");if(e==undefined)return;var t=this.tablet;var n=t.find(".statusmsg").detach();t.empty().append(e);if(n)t.find(".statusmsg").replaceWith(n);this.events();return this};Tab.prototype.setTitle=function(e){console.log("Tab.setTitle("+e+")");if(this.title!==undefined&&this.title!==e)TABS.rename(this.title,e);this.title=e;this.tabtitlelink.empty().append(e);return this};Tabs.prototype.activate=function(e){this.active=e;this.byId[e].activate()};Tabs.prototype.activateNext=function(){console.log("Looking for a tab to activate...");for(var e=this.active.id+1;e<this.byId.length;++e){console.log("Trying tab "+e);if(this.byId[e]!=undefined){if(this.byId[e].business==g_business){this.activate(e);return true}}}for(var e=this.active.id-1;e>=0;--e){console.log("Trying tab "+e);if(this.byId[e]!=undefined){if(this.byId[e].business==g_business){this.activate(e);return true}}}return false};Tabs.prototype.add=function(e){console.log("Tabs().add()");e.id=this.byId.length;this.byId.push(e);this.byTitle[e.title]=e};Tabs.prototype.close=function(e){delete this.byId[e.id];delete this.byTitle[e.title];if(e.active)this.activateNext()};Tabs.prototype.count=function(){return this.byId.length};Tabs.prototype.refresh=function(e){console.log("Tabs().refresh("+e+")");for(var t=0;t<this.byId.length;t++){if(TABS.byId[t]!=undefined){if(TABS.byId[t].refresh&&TABS.byId[t].collection!=undefined){if(e==undefined||e==TABS.byId[t].collection){TABS.byId[t].reload()}}}}};Tabs.prototype.rename=function(e,t){console.log("Tabs.rename("+e+","+t+")");this.byTitle[t]=this.byTitle[e];delete this.byTitle[e]}
